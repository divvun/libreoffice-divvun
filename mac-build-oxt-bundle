#!/bin/bash


set -e -u

LIBDIVVUN_MAC_RELEASE=https://github.com/divvun/libdivvun/releases/download/v0.3.0/Darwin-64bit-.zip

if [[ $# -lt 1 ]]; then
    cat <<EOF

This script creates a LibreOffice .oxt file that includes all of
libdivvun and its dependencies as well as whatever language data
(zcheck files) you give it.

The regular .oxt file made by libreoffice-divvun assumes the user has
zcheck language data in e.g. ~/.config/voikko/4 or
/usr/share/voikko/4, while the bundle made by this script includes the
language data in the .oxt file itself.

To run this, please supply the zcheck files to include as arguments,
e.g.

\$ ./mac-build-oxt /usr/share/voikko/4/*.zcheck

if your zcheck/divvun language data files are in /usr/share/voikko/4
EOF
    exit 1
fi

mkdir -p oxt/divvun || true

zip="$(mktemp -t libreoffice-divvun-get-travis-libs.XXXXXXXXXXX)"
cleanup () { rm -f "${zip}"; }
trap cleanup EXIT
if command -V curl 2>/dev/null >/dev/null; then
    curl --progress "${LIBDIVVUN_MAC_RELEASE}" > "${zip}"
else
    wget "${LIBDIVVUN_MAC_RELEASE}" -O "${zip}"
fi
unzip -o -d oxt "${zip}"

shift
cp "$@" oxt/divvun

export PATH="/Applications/LibreOffice.app/Contents/MacOS/:$PATH"
make oxt STANDALONE_EXTENSION=1

ls build/divvun.oxt
